name: Playwright Cucumber Allure CI

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      suite:
        description: "Select test suite"
        required: true
        default: "smoke"
        type: choice
        options:
          - smoke
          - regression
      env:
        description: "Environment to run tests against (mandatory)"
        required: true
      browser:
        description: "Browser to use (mandatory)"
        required: true
      threadcount:
        description: "Dataprovider thread count (optional)"
        required: false
        default: "3"
      tags:
        description: "Cucumber tags to execute (optional)"
        required: false
        default: "@smoke"

jobs:

  smoke-tests:
    if: ${{ github.event_name == 'push' || github.event.inputs.suite == 'smoke' }}
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/21.0.10-7/x64
      ENV: ${{ github.event.inputs.env || 'qa' }}
      BROWSER: ${{ github.event.inputs.browser || 'chromium' }}
      HEADLESS: true
      THREADCOUNT: ${{ github.event.inputs.threadcount || '3' }}
      # Safe TAGS fallback: always default to @smoke on push
      TAGS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tags != '' && github.event.inputs.tags || '@smoke' }}
    steps:

      - name: 0Ô∏è‚É£ Validate mandatory inputs
        run: |
          if [ -z "$ENV" ]; then
            echo "ERROR: 'env' is mandatory. Please provide - ENV"
            exit 1
          fi
          if [ -z "$BROWSER" ]; then
            echo "ERROR: 'browser' is mandatory. Please provide - BROWSER"
            exit 1
          fi

      - name: 1Ô∏è‚É£ Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2Ô∏è‚É£ Display Java Version
        run: java -version

      - name: 3Ô∏è‚É£ Setup Java 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      - name: 4Ô∏è‚É£ Install Allure CLI
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxvf allure-2.27.0.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version

      - name: 5Ô∏è‚É£ Prepare History Folder
        run: mkdir -p target/allure-results/history

      - name: 6Ô∏è‚É£ Fetch Existing History from gh-pages safely
        run: |
          if git ls-remote --exit-code origin gh-pages; then
            git fetch origin gh-pages
            git checkout origin/gh-pages -- history-smoke || echo "No previous smoke history folder found, skipping."
          else
            echo "gh-pages branch does not exist yet. Skipping history restore."
          fi

      - name: 7Ô∏è‚É£ Merge Existing History into Allure Results
        run: |
          if [ -d "history-smoke" ]; then
            cp -r history-smoke/* target/allure-results/history/
          fi

      - name: 8Ô∏è‚É£ Display Environment Variables
        run: env | grep -E 'ENV|BROWSER|HEADLESS|THREADCOUNT|TAGS'

      - name: 9Ô∏è‚É£ Install Node and Playwright Browsers
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install -g playwright
          npx playwright install

      - name: üîü Run Test Suite
        id: run_tests
        continue-on-error: true
        run: |
          # clean previous run artifacts
          rm -rf target/allure-results target/cucumber-reports target/failed_scenarios.txt
          mkdir -p target/allure-results
      
          # enforce tag source
          export CUCUMBER_FILTER_TAGS="${TAGS}"
          echo "Using tags: $CUCUMBER_FILTER_TAGS"
      
          xvfb-run --auto-servernum -- mvn test \
            -Denv=$ENV \
            -Dbrowser=$BROWSER \
            -Dheadless=$HEADLESS \
            -Ddataproviderthreadcount=$THREADCOUNT \
            -Dcucumber.filter.tags="$CUCUMBER_FILTER_TAGS"

      - name: 1Ô∏è‚É£1Ô∏è‚É£ Write Allure Environment Info
        run: |
          REPORT_TS=smoke-${{ github.run_id }}-${{ github.run_attempt }}
          cat > target/allure-results/environment.properties <<EOF
          ENV=$ENV
          BROWSER=$BROWSER
          HEADLESS=$HEADLESS
          THREADCOUNT=$THREADCOUNT
          TAGS=$TAGS
          JOB=smoke-tests
          RUN_ID=${{ github.run_id }}
          RUN_ATTEMPT=${{ github.run_attempt }}
          EOF

      - name: 1Ô∏è‚É£2Ô∏è‚É£ Backup Allure History
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          mkdir -p allure-history-backup
          if [ -d "target/allure-results/history" ]; then
            cp -r target/allure-results/history allure-history-backup/history-$TIMESTAMP
            echo "Backup created at allure-history-backup/history-$TIMESTAMP"
          else
            echo "No history folder to backup (first run or test failed before history created)."
          fi

      - name: 1Ô∏è‚É£3Ô∏è‚É£ Skip Clean Old Allure Reports
        run: echo "Skipping cleanup to preserve previous reports"

      - name: 1Ô∏è‚É£4Ô∏è‚É£ Set REPORT_TS shell variable
        run: echo "REPORT_TS=smoke-${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_ENV

      - name: 1Ô∏è‚É£5Ô∏è‚É£ Create Temporary Report Folder
        run: |
          REPORT_TS=smoke-${{ github.run_id }}-${{ github.run_attempt }}
          mkdir -p temp-report-$REPORT_TS

      - name: 1Ô∏è‚É£6Ô∏è‚É£ Generate Allure HTML
        run: |
          REPORT_TS=smoke-${{ github.run_id }}-${{ github.run_attempt }}
          allure generate target/allure-results -o temp-report-$REPORT_TS --clean

      - name: 1Ô∏è‚É£7Ô∏è‚É£ Generate Defect Age Report
        run: |
          REPORT_TS=smoke-${{ github.run_id }}-${{ github.run_attempt }}
          mvn test-compile exec:java \
            -Dexec.mainClass=com.samtech.qa.testutilities.AllureDefectAge \
            -Dexec.classpathScope=test \
            -Dhistory.dir=temp-report-$REPORT_TS/history
          mkdir -p /tmp/defect-age
          cp target/defect-age-report.csv /tmp/defect-age/defect-age-report-$REPORT_TS.csv

      - name: 1Ô∏è‚É£8Ô∏è‚É£ Detect & Upload Latest Failed Locator JSON
        run: |
          FILE=$(ls test-output/failedLocators_*.json 2>/dev/null | sort | tail -n 1 || true)
          if [ -n "$FILE" ]; then
            echo "FILE_PATH=$FILE" >> $GITHUB_ENV
          fi

      - name: 1Ô∏è‚É£9Ô∏è‚É£ Configure Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: 2Ô∏è‚É£0Ô∏è‚É£ Commit Allure Report to gh-pages
        if: always()
        run: |
          REPORT_TS=smoke-${{ github.run_id }}-${{ github.run_attempt }}
          mkdir -p /tmp/allure-report
          cp -r temp-report-$REPORT_TS/* /tmp/allure-report/
          git reset --hard
          git clean -fd
          git fetch origin
          if git ls-remote --exit-code origin gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
          fi
          mkdir -p report-$REPORT_TS
          cp -r /tmp/allure-report/* report-$REPORT_TS/
          rm -rf history-smoke
          cp -r /tmp/allure-report/history history-smoke || true
          git add .
          git commit -m "Update Allure report $REPORT_TS" || echo "No changes to commit"
          git push origin gh-pages --force

      - name: 2Ô∏è‚É£1Ô∏è‚É£ Upload Allure Results Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results

      - name: 2Ô∏è‚É£2Ô∏è‚É£ Upload Failed Locators Artifact
        if: env.FILE_PATH != ''
        uses: actions/upload-artifact@v4
        with:
          name: Failed_locators
          path: ${{ env.FILE_PATH }}

      - name: 2Ô∏è‚É£3Ô∏è‚É£ Upload Defect Age Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: defect-age-report
          path: /tmp/defect-age/defect-age-report-${{ github.run_id }}-${{ github.run_attempt }}.csv
          if-no-files-found: warn

      - name: 2Ô∏è‚É£4Ô∏è‚É£ Display GitHub Pages Report URL
        run: |
          REPORT_TS=smoke-${{ github.run_id }}-${{ github.run_attempt }}
          echo "Report URL: https://atulbmhetre.github.io/playwright-cucumber-framework/report-$REPORT_TS"

      - name: 2Ô∏è‚É£5Ô∏è‚É£ Fail job if tests failed
        if: steps.run_tests.outcome == 'failure'
        run: exit 1

  regression-tests:
    needs: smoke-tests
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.suite == 'regression' }}
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/21.0.10-7/x64
      ENV: ${{ github.event.inputs.env }}
      BROWSER: ${{ github.event.inputs.browser }}
      HEADLESS: true
      THREADCOUNT: ${{ github.event.inputs.threadcount }}
      TAGS: ${{ github.event.inputs.tags }}
    steps:

      # Regression steps fully expanded with REPORT_TS="regression-..." and HISTORY="history-regression"
      - name: 0Ô∏è‚É£ Validate mandatory inputs
        run: |
          if [ -z "$ENV" ]; then
            echo "ERROR: 'env' is mandatory. Please provide - ENV"
            exit 1
          fi
          if [ -z "$BROWSER" ]; then
            echo "ERROR: 'browser' is mandatory. Please provide - BROWSER"
            exit 1
          fi

      - name: 1Ô∏è‚É£ Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2Ô∏è‚É£ Display Java Version
        run: java -version

      - name: 3Ô∏è‚É£ Setup Java 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      - name: 4Ô∏è‚É£ Install Allure CLI
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxvf allure-2.27.0.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version

      - name: 5Ô∏è‚É£ Prepare History Folder
        run: mkdir -p target/allure-results/history

      - name: 6Ô∏è‚É£ Fetch Existing History from gh-pages safely
        run: |
          if git ls-remote --exit-code origin gh-pages; then
            git fetch origin gh-pages
            git checkout origin/gh-pages -- history-regression || echo "No previous regression history folder found, skipping."
          else
            echo "gh-pages branch does not exist yet. Skipping history restore."
          fi

      - name: 7Ô∏è‚É£ Merge Existing History into Allure Results
        run: |
          if [ -d "history-regression" ]; then
            cp -r history-regression/* target/allure-results/history/
          fi

      - name: 8Ô∏è‚É£ Display Environment Variables
        run: env | grep -E 'ENV|BROWSER|HEADLESS|THREADCOUNT|TAGS'

      - name: 9Ô∏è‚É£ Install Node and Playwright Browsers
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install -g playwright
          npx playwright install

      - name: üîü Run Test Suite
        id: run_tests
        continue-on-error: true
        run: |
          REPORT_TS=regression-${{ github.run_id }}-${{ github.run_attempt }}
          rm -rf target/allure-results target/cucumber-reports target/failed_scenarios.txt
          mkdir -p target/allure-results
          export CUCUMBER_FILTER_TAGS="$TAGS"
          echo "Using tags: $CUCUMBER_FILTER_TAGS"
          xvfb-run --auto-servernum -- mvn test \
            -Denv=$ENV \
            -Dbrowser=$BROWSER \
            -Dheadless=$HEADLESS \
            -Ddataproviderthreadcount=$THREADCOUNT \
            -Dcucumber.filter.tags="$CUCUMBER_FILTER_TAGS"

      - name: 1Ô∏è‚É£1Ô∏è‚É£ Write Allure Environment Info
        run: |
          REPORT_TS=regression-${{ github.run_id }}-${{ github.run_attempt }}
          cat > target/allure-results/environment.properties <<EOF
          ENV=$ENV
          BROWSER=$BROWSER
          HEADLESS=$HEADLESS
          THREADCOUNT=$THREADCOUNT
          TAGS=$TAGS
          JOB=regression-tests
          RUN_ID=${{ github.run_id }}
          RUN_ATTEMPT=${{ github.run_attempt }}
          EOF

      - name: 1Ô∏è‚É£2Ô∏è‚É£ Backup Allure History
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          mkdir -p allure-history-backup
          if [ -d "target/allure-results/history" ]; then
            cp -r target/allure-results/history allure-history-backup/history-$TIMESTAMP
            echo "Backup created at allure-history-backup/history-$TIMESTAMP"
          else
            echo "No history folder to backup (first run or test failed before history created)."
          fi

      - name: 1Ô∏è‚É£3Ô∏è‚É£ Skip Clean Old Allure Reports
        run: echo "Skipping cleanup to preserve previous reports"

      - name: 1Ô∏è‚É£4Ô∏è‚É£ Set REPORT_TS shell variable
        run: echo "REPORT_TS=regression-${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_ENV

      - name: 1Ô∏è‚É£5Ô∏è‚É£ Create Temporary Report Folder
        run: |
          REPORT_TS=regression-${{ github.run_id }}-${{ github.run_attempt }}
          mkdir -p temp-report-$REPORT_TS

      - name: 1Ô∏è‚É£6Ô∏è‚É£ Generate Allure HTML
        run: |
          REPORT_TS=regression-${{ github.run_id }}-${{ github.run_attempt }}
          allure generate target/allure-results -o temp-report-$REPORT_TS --clean

      - name: 1Ô∏è‚É£7Ô∏è‚É£ Generate Defect Age Report
        run: |
          REPORT_TS=regression-${{ github.run_id }}-${{ github.run_attempt }}
          mvn test-compile exec:java \
            -Dexec.mainClass=com.samtech.qa.testutilities.AllureDefectAge \
            -Dexec.classpathScope=test \
            -Dhistory.dir=temp-report-$REPORT_TS/history
          mkdir -p /tmp/defect-age
          cp target/defect-age-report.csv /tmp/defect-age/defect-age-report-$REPORT_TS.csv

      - name: 1Ô∏è‚É£8Ô∏è‚É£ Detect & Upload Latest Failed Locator JSON
        run: |
          FILE=$(ls test-output/failedLocators_*.json 2>/dev/null | sort | tail -n 1 || true)
          if [ -n "$FILE" ]; then
            echo "FILE_PATH=$FILE" >> $GITHUB_ENV
          fi

      - name: 1Ô∏è‚É£9Ô∏è‚É£ Configure Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: 2Ô∏è‚É£0Ô∏è‚É£ Commit Allure Report to gh-pages
        if: always()
        run: |
          REPORT_TS=regression-${{ github.run_id }}-${{ github.run_attempt }}
          mkdir -p /tmp/allure-report
          cp -r temp-report-$REPORT_TS/* /tmp/allure-report/
          git reset --hard
          git clean -fd
          git fetch origin
          if git ls-remote --exit-code origin gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
          fi
          mkdir -p report-$REPORT_TS
          cp -r /tmp/allure-report/* report-$REPORT_TS/
          rm -rf history-regression
          cp -r /tmp/allure-report/history history-regression || true
          git add .
          git commit -m "Update Allure report $REPORT_TS" || echo "No changes to commit"
          git push origin gh-pages --force

      - name: 2Ô∏è‚É£1Ô∏è‚É£ Upload Allure Results Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results

      - name: 2Ô∏è‚É£2Ô∏è‚É£ Upload Failed Locators Artifact
        if: env.FILE_PATH != ''
        uses: actions/upload-artifact@v4
        with:
          name: Failed_locators
          path: ${{ env.FILE_PATH }}

      - name: 2Ô∏è‚É£3Ô∏è‚É£ Upload Defect Age Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: defect-age-report
          path: /tmp/defect-age/defect-age-report-${{ github.run_id }}-${{ github.run_attempt }}.csv
          if-no-files-found: warn

      - name: 2Ô∏è‚É£4Ô∏è‚É£ Display GitHub Pages Report URL
        run: |
          REPORT_TS=regression-${{ github.run_id }}-${{ github.run_attempt }}
          echo "Report URL: https://atulbmhetre.github.io/playwright-cucumber-framework/report-$REPORT_TS"

      - name: 2Ô∏è‚É£5Ô∏è‚É£ Fail job if tests failed
        if: steps.run_tests.outcome == 'failure'
        run: exit 1