name: Playwright Cucumber Allure CI

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      suite:
        description: "Select test suite"
        required: true
        default: "smoke"
        type: choice
        options:
          - smoke
          - regression
      env:
        description: "Environment to run tests against (mandatory)"
        required: true
      browser:
        description: "Browser to use (mandatory)"
        required: true
      threadcount:
        description: "Dataprovider thread count (optional)"
        required: false
        default: "3"
      tags:
        description: "Cucumber tags to execute (optional)"
        required: false
        default: "@smoke"

jobs:

  smoke-tests:
    if: ${{ github.event_name == 'push' || github.event.inputs.suite == 'smoke' }}
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/21.0.10-7/x64
      ENV: ${{ github.event.inputs.env || 'qa' }}
      BROWSER: ${{ github.event.inputs.browser || 'chromium' }}
      HEADLESS: true
      THREADCOUNT: ${{ github.event.inputs.threadcount || '3' }}
      TAGS: ${{ github.event.inputs.tags || '@smoke' }}
    steps:

      # 0Ô∏è‚É£ Mandatory input check
      - name: Validate mandatory inputs
        run: |
          if [ -z "$ENV" ]; then
            echo "ERROR: 'env' is mandatory. Please provide - ENV"
            exit 1
          fi
          if [ -z "$BROWSER" ]; then
            echo "ERROR: 'browser' is mandatory. Please provide - BROWSER"
            exit 1
          fi

      # 1Ô∏è‚É£ Checkout the repository
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Display Java version
      - name: Display Java Version
        run: java -version

      # 3Ô∏è‚É£ Setup Java 21
      - name: Setup Java 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      # 4Ô∏è‚É£ Install Allure CLI
      - name: Install Allure CLI
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxvf allure-2.27.0.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version

      # 5Ô∏è‚É£ Prepare history folder
      - name: Prepare History Folder
        run: mkdir -p target/allure-results/history

      # 6Ô∏è‚É£ Fetch existing history from gh-pages
      - name: Fetch Existing History from gh-pages
        run: |
          if git ls-remote --exit-code origin gh-pages; then
            git fetch origin gh-pages
            git checkout origin/gh-pages -- history || echo "No history folder found"
          else
            echo "gh-pages branch does not exist yet. Skipping history restore."
          fi

      # 7Ô∏è‚É£ Merge existing history into current results
      - name: Merge Existing History into Allure Results
        run: cp -r history/* target/allure-results/history/ || echo "No previous history to copy"

      # 8Ô∏è‚É£ Display environment variables
      - name: Display Environment Variables
        run: env | grep -E 'ENV|BROWSER|HEADLESS|THREADCOUNT|TAGS'

      # 9Ô∏è‚É£ Install Node & Playwright
      - name: Install Node and Playwright Browsers
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install -g playwright
          npx playwright install

      # üîü Run Maven tests
      - name: Run Test Suite
        id: run_tests
        continue-on-error: true
        run: |
          xvfb-run --auto-servernum -- mvn test \
            -Denv=$ENV \
            -Dbrowser=$BROWSER \
            -Dheadless=$HEADLESS \
            -Ddataproviderthreadcount=$THREADCOUNT \
            -Dcucumber.filter.tags="$TAGS"

      # 1Ô∏è‚É£1Ô∏è‚É£ Backup history folder with timestamp
      - name: Backup Allure History
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          mkdir -p allure-history-backup
          cp -r target/allure-results/history allure-history-backup/history-$TIMESTAMP
          echo "Backup created at allure-history-backup/history-$TIMESTAMP"

      # 1Ô∏è‚É£2Ô∏è‚É£ Clean previous Allure reports
      - name: Clean Old Allure Reports
        run: rm -rf gh-pages/report-*

      # 1Ô∏è‚É£3Ô∏è‚É£ Set timestamp for report
      - name: Set Timestamp for Report
        id: timestamp
        run: echo "REPORT_TS=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      # 1Ô∏è‚É£4Ô∏è‚É£ Create temporary report folder
      - name: Create Temporary Report Folder
        run: mkdir -p temp-report-${{ env.REPORT_TS }}

      # 1Ô∏è‚É£5Ô∏è‚É£ Generate Allure HTML into temp folder
      - name: Generate Allure HTML
        run: |
          echo "====== ENTERED STEP 15 - GENERATE ALLURE HTML ======"
          allure generate target/allure-results -o temp-report-${{ env.REPORT_TS }} --clean
          echo "====== ALLURE HTML GENERATED ======"

      # 1Ô∏è‚É£6Ô∏è‚É£ Generate Defect Age Report
      - name: Generate Defect Age Report
        run: |
          echo "====== GENERATING DEFECT AGE REPORT ======"
          mvn test-compile exec:java \
            -Dexec.mainClass=com.samtech.qa.testutilities.AllureDefectAge \
            -Dexec.classpathScope=test \
            -Dhistory.dir=temp-report-${{ env.REPORT_TS }}/history
          echo "====== DEFECT AGE REPORT GENERATED ======"

      # 1Ô∏è‚É£7Ô∏è‚É£ List generated report contents
      - name: List Generated Report
        run: ls -l temp-report-${{ env.REPORT_TS }}

      # 1Ô∏è‚É£8Ô∏è‚É£ Configure Git for push
      - name: Configure Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Debug Report Folders
        if: always()
        run: |
          echo "=== ROOT ==="
          ls -l
          echo "=== TARGET ==="
          ls -l target || true
          echo "=== TEMP REPORTS ==="
          ls -l temp-report-* || true

      # 1Ô∏è‚É£9Ô∏è‚É£ Commit Allure HTML to gh-pages (FINAL SAFE VERSION)
      - name: Commit Allure Report
        if: always()
        run: |
          echo "Preparing safe publish..."
          
          # Copy report outside repo first
          mkdir -p /tmp/allure-report
          cp -r temp-report-${{ env.REPORT_TS }}/* /tmp/allure-report/
          
          # Clean working tree completely
          git reset --hard
          git clean -fd
          
          git fetch origin
          
          if git ls-remote --exit-code origin gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
          fi
          
          # Remove everything tracked
          git rm -rf . || true
          
          # Copy fresh report
          cp -r /tmp/allure-report/* .
          
          git add .
          git commit -m "Update Allure report ${{ env.REPORT_TS }}" || echo "No changes to commit"
          
          git push origin gh-pages --force

      # 2Ô∏è‚É£0Ô∏è‚É£ Push Allure HTML to gh-pages
      - name: Push Report to GitHub Pages
        run: git push -u origin gh-pages

      # 2Ô∏è‚É£1Ô∏è‚É£ Upload Allure results as artifact
      - name: Upload Allure Results Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results

      # 2Ô∏è‚É£2Ô∏è‚É£ Upload Latest Failed Locator JSON
      - name: Detect Latest Failed Locator JSON
        run: |
          FILE=$(ls test-output/failedLocators_*.json 2>/dev/null | sort | tail -n 1)
          if [ -n "$FILE" ]; then
            echo "FILE_PATH=$FILE" >> $GITHUB_ENV
          else
            echo "No failedLocators JSON found."
          fi

      - name: Upload Failed Locators Artifact
        if: env.FILE_PATH != ''
        uses: actions/upload-artifact@v4
        with:
          name: Failed_locators
          path: ${{ env.FILE_PATH }}

      # 2Ô∏è‚É£3Ô∏è‚É£ Upload Defect Age Report Artifact
      - name: Upload Defect Age Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: defect-age-report
          path: target/defect-age-report.csv
          if-no-files-found: warn

      # 2Ô∏è‚É£4Ô∏è‚É£ Display GitHub Pages report URL
      - name: Display Report URL
        run: |
          echo "Report URL: https://atulbmhetre.github.io/playwright-cucumber-framework/report-${{ env.REPORT_TS }}"

      # 2Ô∏è‚É£5Ô∏è‚É£ Fail job if tests failed
      - name: Fail job if tests failed
        if: steps.run_tests.outcome == 'failure'
        run: exit 1

  regression-tests:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.suite == 'regression' }}
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/21.0.10-7/x64
      ENV: ${{ github.event.inputs.env }}
      BROWSER: ${{ github.event.inputs.browser }}
      HEADLESS: true
      THREADCOUNT: ${{ github.event.inputs.threadcount }}
      TAGS: ${{ github.event.inputs.tags }}
    steps:

      # 0Ô∏è‚É£ Mandatory input check
      - name: Validate mandatory inputs
        run: |
          if [ -z "$ENV" ]; then
            echo "ERROR: 'env' is mandatory. Please provide - ENV"
            exit 1
          fi
          if [ -z "$BROWSER" ]; then
            echo "ERROR: 'browser' is mandatory. Please provide - BROWSER"
            exit 1
          fi

      # 1Ô∏è‚É£ Checkout the repository
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Display Java version
      - name: Display Java Version
        run: java -version

      # 3Ô∏è‚É£ Setup Java 21
      - name: Setup Java 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      # 4Ô∏è‚É£ Install Allure CLI
      - name: Install Allure CLI
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxvf allure-2.27.0.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version

      # 5Ô∏è‚É£ Prepare history folder
      - name: Prepare History Folder
        run: mkdir -p target/allure-results/history

      # 6Ô∏è‚É£ Fetch existing history from gh-pages
      - name: Fetch Existing History from gh-pages
        run: |
          if git ls-remote --exit-code origin gh-pages; then
            git fetch origin gh-pages
            git checkout origin/gh-pages -- history || echo "No history folder found"
          else
            echo "gh-pages branch does not exist yet. Skipping history restore."
          fi

      # 7Ô∏è‚É£ Merge existing history into current results
      - name: Merge Existing History into Allure Results
        run: cp -r history/* target/allure-results/history/ || echo "No previous history to copy"

      # 8Ô∏è‚É£ Display environment variables
      - name: Display Environment Variables
        run: env | grep -E 'ENV|BROWSER|HEADLESS|THREADCOUNT|TAGS'

      # 9Ô∏è‚É£ Install Node & Playwright
      - name: Install Node and Playwright Browsers
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install -g playwright
          npx playwright install

      # üîü Run Maven tests
      - name: Run Test Suite
        continue-on-error: true
        run: |
          xvfb-run --auto-servernum -- mvn test \
            -Denv=$ENV \
            -Dbrowser=$BROWSER \
            -Dheadless=$HEADLESS \
            -Ddataproviderthreadcount=$THREADCOUNT \
            -Dcucumber.filter.tags="$TAGS"

      # 1Ô∏è‚É£1Ô∏è‚É£ Backup history folder with timestamp
      - name: Backup Allure History
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          mkdir -p allure-history-backup
          cp -r target/allure-results/history allure-history-backup/history-$TIMESTAMP
          echo "Backup created at allure-history-backup/history-$TIMESTAMP"

      # 1Ô∏è‚É£2Ô∏è‚É£ Clean previous Allure reports
      - name: Clean Old Allure Reports
        run: rm -rf gh-pages/report-*

      # 1Ô∏è‚É£3Ô∏è‚É£ Set timestamp for report
      - name: Set Timestamp for Report
        id: timestamp
        run: echo "REPORT_TS=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      # 1Ô∏è‚É£4Ô∏è‚É£ Create temporary report folder
      - name: Create Temporary Report Folder
        run: mkdir -p temp-report-${{ env.REPORT_TS }}

      # 1Ô∏è‚É£5Ô∏è‚É£ Generate Allure HTML into temp folder
      - name: Generate Allure HTML
        run: |
          echo "====== ENTERED STEP 15 - GENERATE ALLURE HTML ======"
          allure generate target/allure-results -o temp-report-${{ env.REPORT_TS }} --clean
          echo "====== ALLURE HTML GENERATED ======"

      # 1Ô∏è‚É£6Ô∏è‚É£ Generate Defect Age Report
      - name: Generate Defect Age Report
        run: |
          echo "====== GENERATING DEFECT AGE REPORT ======"
          mvn test-compile exec:java \
            -Dexec.mainClass=com.samtech.qa.testutilities.AllureDefectAge \
            -Dexec.classpathScope=test \
            -Dhistory.dir=temp-report-${{ env.REPORT_TS }}/history
          echo "====== DEFECT AGE REPORT GENERATED ======"

      # 1Ô∏è‚É£7Ô∏è‚É£ List generated report contents
      - name: List Generated Report
        run: ls -l temp-report-${{ env.REPORT_TS }}

      # 1Ô∏è‚É£8Ô∏è‚É£ Configure Git for push
      - name: Configure Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Debug Report Folders
        if: always()
        run: |
          echo "=== ROOT ==="
          ls -l
          echo "=== TARGET ==="
          ls -l target || true
          echo "=== TEMP REPORTS ==="
          ls -l temp-report-* || true

      # 1Ô∏è‚É£9Ô∏è‚É£ Commit Allure HTML to gh-pages (FINAL SAFE VERSION)
      - name: Commit Allure Report
        if: always()
        run: |
          echo "Preparing safe publish..."
          
          # Copy report outside repo first
          mkdir -p /tmp/allure-report
          cp -r temp-report-${{ env.REPORT_TS }}/* /tmp/allure-report/
          
          # Clean working tree completely
          git reset --hard
          git clean -fd
          
          git fetch origin
          
          if git ls-remote --exit-code origin gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
          fi
          
          # Remove everything tracked
          git rm -rf . || true
          
          # Copy fresh report
          cp -r /tmp/allure-report/* .
          
          git add .
          git commit -m "Update Allure report ${{ env.REPORT_TS }}" || echo "No changes to commit"
          
          git push origin gh-pages --force

      # 2Ô∏è‚É£0Ô∏è‚É£ Push Allure HTML to gh-pages
      - name: Push Report to GitHub Pages
        run: git push -u origin gh-pages

      # 2Ô∏è‚É£1Ô∏è‚É£ Upload Allure results as artifact
      - name: Upload Allure Results Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results

      # 2Ô∏è‚É£2Ô∏è‚É£ Upload Latest Failed Locator JSON
      - name: Detect Latest Failed Locator JSON
        run: |
          FILE=$(ls test-output/failedLocators_*.json 2>/dev/null | sort | tail -n 1)
          if [ -n "$FILE" ]; then
            echo "FILE_PATH=$FILE" >> $GITHUB_ENV
          else
            echo "No failedLocators JSON found."
          fi

      - name: Upload Failed Locators Artifact
        if: env.FILE_PATH != ''
        uses: actions/upload-artifact@v4
        with:
          name: Failed_locators
          path: ${{ env.FILE_PATH }}

      # 2Ô∏è‚É£3Ô∏è‚É£ Upload Defect Age Report Artifact
      - name: Upload Defect Age Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: defect-age-report
          path: target/defect-age-report.csv
          if-no-files-found: warn

      # 2Ô∏è‚É£4Ô∏è‚É£ Display GitHub Pages report URL
      - name: Display Report URL
        run: |
          echo "Report URL: https://atulbmhetre.github.io/playwright-cucumber-framework/report-${{ env.REPORT_TS }}"
