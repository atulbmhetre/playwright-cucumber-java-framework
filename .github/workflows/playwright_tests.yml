name: Playwright Cucumber Allure CI

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-tests-and-publish-allure:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/21.0.10-7/x64
      ENV: qa
      BROWSER: chromium
      HEADLESS: true

    steps:

      # 1Ô∏è‚É£ Checkout the repository
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Display Java version (debugging)
      - name: Display Java Version
        run: java -version

      # 3Ô∏è‚É£ Setup Java 21
      - name: Setup Java 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      # 4Ô∏è‚É£ Install Allure CLI
      - name: Install Allure CLI
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxvf allure-2.27.0.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version

      # 5Ô∏è‚É£ Prepare history folder
      - name: Prepare History Folder
        run: mkdir -p target/allure-results/history

      # 6Ô∏è‚É£ Fetch existing history from gh-pages
      - name: Fetch Existing History from gh-pages
        run: |
          git fetch origin gh-pages
          git checkout gh-pages -- history || echo "No history found"

      # 7Ô∏è‚É£ Merge existing history into current results
      - name: Merge Existing History into Allure Results
        run: cp -r history/* target/allure-results/history/ || echo "No previous history to copy"

      # 8Ô∏è‚É£ Display environment variables
      - name: Display Environment Variables
        run: env | grep -E 'ENV|BROWSER|HEADLESS'

      # 9Ô∏è‚É£ Install Node & Playwright
      - name: Install Node and Playwright Browsers
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install -g playwright
          npx playwright install

      # üîü Run Maven tests
      - name: Run Test Suite
        run: |
          xvfb-run --auto-servernum -- mvn test \
            -Denv=$ENV \
            -Dbrowser=$BROWSER \
            -Dheadless=$HEADLESS \
            -Ddataproviderthreadcount=3 \
            -Dretry=1 \
            -Dcucumber.filter.tags="@Login" || true

      # 11Ô∏è‚É£ Backup history folder with timestamp
      - name: Backup Allure History
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          mkdir -p allure-history-backup
          cp -r target/allure-results/history allure-history-backup/history-$TIMESTAMP
          echo "Backup created at allure-history-backup/history-$TIMESTAMP"

      # 12Ô∏è‚É£ Clean previous Allure reports
      - name: Clean Old Allure Reports
        run: rm -rf gh-pages/report-*

      # 13Ô∏è‚É£ Set timestamp for report (make it available to all steps)
      - name: Set Timestamp for Report
        id: timestamp
        run: echo "REPORT_TS=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      # 14Ô∏è‚É£ Create temporary report folder for current run
      - name: Create Temporary Report Folder
        run: mkdir -p temp-report-${{ env.REPORT_TS }}

      # 15Ô∏è‚É£ Generate Allure HTML into temp folder
      - name: Generate Allure HTML
        run: allure generate target/allure-results -o temp-report-${{ env.REPORT_TS }} --clean

      # 16Ô∏è‚É£ List generated report contents
      - name: List Generated Report
        run: ls -l temp-report-${{ env.REPORT_TS }}

      # 17Ô∏è‚É£ Configure Git for push
      - name: Configure Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      # 18Ô∏è‚É£ Commit Allure HTML to gh-pages
      - name: Commit Allure Report
        run: |
          git fetch origin
          # Switch to gh-pages branch, create if missing
          if git ls-remote --exit-code origin gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi

          # Copy temp report into gh-pages folder
          mkdir -p report-${{ env.REPORT_TS }}
          cp -r temp-report-${{ env.REPORT_TS }}/* report-${{ env.REPORT_TS }}/

          git add report-${{ env.REPORT_TS }}
          git commit -m "Update Allure report ${{ env.REPORT_TS }}" || echo "No changes to commit"

      # 19Ô∏è‚É£ Push Allure HTML to gh-pages
      - name: Push Report to GitHub Pages
        run: git push -u origin gh-pages

#      # 20Ô∏è‚É£ Upload Allure results as artifact
#      - name: Upload Allure Results Artifact
#        uses: actions/upload-artifact@v4
#        with:
#          name: allure-results
#          path: target/allure-results

      # 21Ô∏è‚É£ Upload Test Output Artifact
      - name: Upload Latest Failed Locator JSON
        run: |
          echo "Waiting for failedLocators JSON to exist..."
          for i in {1..10}; do
            FILE=$(ls test-output/failedLocators_*.json 2>/dev/null | sort | tail -n 1)
            if [ -n "$FILE" ]; then
              echo "Found file: $FILE"
              break
            fi
            echo "File not found yet, waiting 2s..."
            sleep 2
          done
          
          if [ -n "$FILE" ]; then
            echo "Uploading $FILE"
            gh-actions-upload-artifact "$FILE" "Failed_locators"
          else
            echo "No failedLocators JSON found. Skipping upload."
          fi
        shell: bash

      # 22Ô∏è‚É£ Display GitHub Pages report URL
      - name: Display Report URL
        run: |
          echo "Report URL: https://atulbmhetre.github.io/playwright-cucumber-framework/report-${{ env.REPORT_TS }}"
