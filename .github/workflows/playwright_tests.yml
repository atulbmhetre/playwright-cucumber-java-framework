name: Playwright Cucumber Allure CI

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      suite:
        description: "Select test suite"
        required: true
        default: "smoke"
        type: choice
        options:
          - smoke
          - regression
      env:
        description: "Environment to run tests against (mandatory)"
        required: true
      browser:
        description: "Browser to use (mandatory)"
        required: true
      threadcount:
        description: "Dataprovider thread count (optional)"
        required: false
        default: "3"
      tags:
        description: "Cucumber tags to execute (optional)"
        required: false
        default: "@smoke"

jobs:
  tests:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/21.0.10-7/x64
      HEADLESS: true
    steps:
      - name: Validate mandatory inputs
        run: |
          if [ -z "${{ github.event.inputs.env }}" ]; then
            echo "ERROR: 'env' is mandatory."
            exit 1
          fi
          if [ -z "${{ github.event.inputs.browser }}" ]; then
            echo "ERROR: 'browser' is mandatory."
            exit 1
          fi

      - name: Set Dynamic Variables
        run: |
          echo "JOB_SUITE=${{ github.event.inputs.suite }}" >> $GITHUB_ENV
          echo "ENV=${{ github.event.inputs.env }}" >> $GITHUB_ENV
          echo "BROWSER=${{ github.event.inputs.browser }}" >> $GITHUB_ENV
          echo "THREADCOUNT=${{ github.event.inputs.threadcount || '3' }}" >> $GITHUB_ENV
          echo "TAGS=${{ github.event.inputs.tags || '@smoke' }}" >> $GITHUB_ENV
          echo "REPORT_TS=${{ github.event.inputs.suite }}-${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_ENV
          echo "HISTORY_DIR=history-${{ github.event.inputs.suite }}" >> $GITHUB_ENV

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      - name: Display Java Version
        run: java -version

      - name: Install Node & Playwright
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install -g playwright
          npx playwright install

      - name: Install Allure CLI
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxvf allure-2.27.0.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version

      - name: Prepare Allure Results & History
        run: |
          mkdir -p target/allure-results/history
          # Fetch existing history safely
          if git ls-remote --exit-code origin gh-pages; then
            git fetch origin gh-pages
            git checkout origin/gh-pages -- ${{ env.HISTORY_DIR }} || echo "No previous ${{ env.HISTORY_DIR }} found"
          fi
          cp -r ${{ env.HISTORY_DIR }}/* target/allure-results/history/ 2>/dev/null || echo "No previous history to copy"

      - name: Clean Target & Run Tests
        id: run_tests
        continue-on-error: true
        run: |
          rm -rf target/allure-results target/cucumber-reports target/failed_scenarios.txt
          mkdir -p target/allure-results
          export CUCUMBER_FILTER_TAGS="${{ env.TAGS }}"
          xvfb-run --auto-servernum -- mvn test \
            -Denv=${{ env.ENV }} \
            -Dbrowser=${{ env.BROWSER }} \
            -Dheadless=${{ env.HEADLESS }} \
            -Ddataproviderthreadcount=${{ env.THREADCOUNT }} \
            -Dcucumber.filter.tags="$CUCUMBER_FILTER_TAGS"

      - name: Write Allure Environment Info
        run: |
          cat > target/allure-results/environment.properties <<EOF
          ENV=${{ env.ENV }}
          BROWSER=${{ env.BROWSER }}
          HEADLESS=${{ env.HEADLESS }}
          THREADCOUNT=${{ env.THREADCOUNT }}
          TAGS=${{ env.TAGS }}
          JOB=${{ env.JOB_SUITE }}
          RUN_ID=${{ github.run_id }}
          RUN_ATTEMPT=${{ github.run_attempt }}
          EOF

      - name: Backup Allure History
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          mkdir -p allure-history-backup
          cp -r target/allure-results/history allure-history-backup/history-$TIMESTAMP

      - name: Generate Allure HTML Report
        run: |
          TEMP_REPORT=temp-report-${{ env.REPORT_TS }}
          mkdir -p $TEMP_REPORT
          allure generate target/allure-results -o $TEMP_REPORT --clean

      - name: Generate Defect Age Report
        run: |
          TEMP_REPORT=temp-report-${{ env.REPORT_TS }}
          mkdir -p /tmp/defect-age
          mvn test-compile exec:java \
            -Dexec.mainClass=com.samtech.qa.testutilities.AllureDefectAge \
            -Dexec.classpathScope=test \
            -Dhistory.dir=$TEMP_REPORT/history
          cp target/defect-age-report.csv /tmp/defect-age/defect-age-report-${{ env.REPORT_TS }}.csv || echo "No defect-age CSV generated"

      - name: Commit Allure HTML to gh-pages
        if: always()
        run: |
          TEMP_REPORT=temp-report-${{ env.REPORT_TS }}
          mkdir -p /tmp/allure-report
          cp -r $TEMP_REPORT/* /tmp/allure-report/
          git reset --hard
          git clean -fd
          git fetch origin
          if git ls-remote --exit-code origin gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
          fi
          mkdir -p report-${{ env.REPORT_TS }}
          cp -r /tmp/allure-report/* report-${{ env.REPORT_TS }}/
          rm -rf ${{ env.HISTORY_DIR }}
          cp -r /tmp/allure-report/history ${{ env.HISTORY_DIR }} 2>/dev/null || true
          git add .
          git commit -m "Update Allure report ${{ env.REPORT_TS }}" || echo "No changes to commit"
          git push origin gh-pages --force

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results

      - name: Upload Defect Age Artifact
        uses: actions/upload-artifact@v4
        with:
          name: defect-age-report
          path: /tmp/defect-age/defect-age-report-${{ env.REPORT_TS }}.csv
          if-no-files-found: warn

      - name: Detect & Upload Latest Failed Locator JSON
        run: |
          FILE=$(ls test-output/failedLocators_*.json 2>/dev/null | sort | tail -n 1 || true)
          if [ -n "$FILE" ]; then
            echo "Uploading $FILE"
            gh-action-upload-artifact name=Failed_locators path=$FILE
          fi

      - name: Display Report URL
        run:
        echo "Report URL: https://atulbmhetre.github.io/playwright-cucumber-framework/report-${{ env.REPORT_TS }}"

      - name: Fail job if tests failed
        if: steps.run_tests.outcome == 'failure'
        run: exit 1
