name: Regression Tests Execution

on:
  workflow_run:
    workflows: ["Smoke Tests Execution"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      env:
        description: 'Test environment'
        default: 'qa'
      browser:
        description: 'Browser to run tests'
        default: 'chromium'
      headless:
        description: 'Headless mode'
        default: 'true'
      threadcount:
        description: 'Parallel threads'
        default: '1'
      tag:
        description: 'Cucumber tags'
        default: '@regression'

jobs:
  regression-job:
    runs-on: ubuntu-latest
    # FIX: explicit conclusion check prevents regression
    # running when smoke fails or is cancelled
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success')

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 0ï¸âƒ£  Guard â€” exit immediately if smoke failed
      #      Reliable fix for GitHub's workflow_run
      #      conclusion check quirk
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check Smoke Conclusion
        run: |
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          echo "Smoke workflow conclusion: ${CONCLUSION}"
          if [ "${{ github.event_name }}" = "workflow_run" ] && [ "${CONCLUSION}" != "success" ]; then
            echo "âŒ Smoke did not pass (conclusion: ${CONCLUSION}) â€” skipping regression"
            exit 1
          fi
          echo "âœ… Smoke passed â€” proceeding with regression"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1ï¸âƒ£  Checkout main branch
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout Main
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2ï¸âƒ£  Setup Java 21
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3ï¸âƒ£  Install Allure CLI
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Allure CLI
        run: npm install -g allure-commandline

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4ï¸âƒ£  Install Playwright browsers via Java CLI
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Playwright Browsers
        run: mvn exec:java -e -D exec.mainClass=com.microsoft.playwright.CLI -D exec.args="install --with-deps" -D exec.classpathScope=test

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5ï¸âƒ£  Restore shared history from gh-pages
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout gh-pages for History
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Restore Shared History
        run: |
          rm -rf target/allure-results
          mkdir -p target/allure-results/history
          if [ -d gh-pages/allure-history/shared/history ]; then
            echo "âœ… Shared history found â€” restoring"
            cp -r gh-pages/allure-history/shared/history/. target/allure-results/history/
          else
            echo "â„¹ï¸  No shared history yet â€” first run"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6ï¸âƒ£  Resolve build number
      #      Auto-triggered: pair with smoke build number
      #      Manual: use own run number
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Resolve Build Number
        id: build
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "number=${{ github.event.workflow_run.run_number }}" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Auto-triggered â€” using smoke build number: ${{ github.event.workflow_run.run_number }}"
          else
            echo "number=${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Manual trigger â€” using own run number: ${{ github.run_number }}"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7ï¸âƒ£  Run Regression Tests
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Regression Tests
        id: run
        continue-on-error: true
        run: |
          xvfb-run --auto-servernum -- mvn clean test \
            -Dtestng.suite.file=testng-regression.xml \
            -Dcucumber.filter.tags="${{ github.event.inputs.tag || '@regression' }}" \
            -Denv="${{ github.event.inputs.env || 'qa' }}" \
            -Dbrowser="${{ github.event.inputs.browser || 'chromium' }}" \
            -Dheadless="${{ github.event.inputs.headless || 'true' }}" \
            -Dparallel.thread.count="${{ github.event.inputs.threadcount || '1' }}" \
            -Dallure.results.directory=target/allure-results

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8ï¸âƒ£  Debug â€” verify outputs
      #      Remove after first confirmed clean run
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Debug â€” Verify Output Paths
        if: always()
        run: |
          echo "====== target/allure-results ======"
          ls -la target/allure-results/ || echo "âŒ NOT FOUND"
          echo "====== history ======"
          ls -la target/allure-results/history/ || echo "âŒ history empty or missing"
          echo "====== environment.properties ======"
          cat target/allure-results/environment.properties || echo "âŒ NOT FOUND"
          echo "====== test-output ======"
          find . -path ./gh-pages -prune -o -name "failedLocators_*.json" -print
          echo "====== defect-age-report ======"
          find . -path ./gh-pages -prune -o -name "defect-age-report.csv" -print

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 9ï¸âƒ£  Generate Defect Age Report
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate Defect Age Report
        if: always()
        run: |
          mvn exec:java \
            -Dexec.mainClass="com.samtech.qa.testutilities.AllureDefectAge" \
            -Dexec.classpathScope=test \
            -Denv="${{ github.event.inputs.env || 'qa' }}" \
            -Dbrowser="${{ github.event.inputs.browser || 'chromium' }}" \
            -Dheadless="${{ github.event.inputs.headless || 'true' }}"
          echo "====== defect-age-report.csv ======"
          cat target/defect-age-report.csv || echo "âŒ not generated"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ”Ÿ  Generate Allure HTML Report
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate Allure Report
        if: always()
        run: |
          allure generate target/allure-results -o allure-report-regression --clean
          echo "====== allure-report-regression/history ======"
          ls allure-report-regression/history/ || echo "âŒ history missing"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1ï¸âƒ£1ï¸âƒ£  Save history + versioned report + index
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Update gh-pages â€” History + Versioned Report + Index
        if: always()
        run: |
          BUILD=${{ steps.build.outputs.number }}
          REPO_NAME=$(echo '${{ github.repository }}' | cut -d'/' -f2)
          REPO_URL="https://${{ github.repository_owner }}.github.io/${REPO_NAME}"
          MAX_BUILDS=20

          # â”€â”€ Clone gh-pages â”€â”€
          rm -rf gh-pages-push
          git clone --branch gh-pages --single-branch \
            https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git \
            gh-pages-push

          cd gh-pages-push

          # â”€â”€ Save shared history â”€â”€
          mkdir -p allure-history/shared
          rm -rf allure-history/shared/history
          cp -r ../allure-report-regression/history allure-history/shared/history

          # â”€â”€ Save versioned regression report â”€â”€
          mkdir -p regression-report/build-${BUILD}
          cp -r ../allure-report-regression/. regression-report/build-${BUILD}/

          # â”€â”€ Write build metadata â”€â”€
          mkdir -p build-meta
          echo "${{ steps.run.outcome }}" > build-meta/regression-${BUILD}.txt

          # â”€â”€ Cleanup old regression builds â”€â”€
          cd regression-report
          ls -d build-* 2>/dev/null | sort -t- -k2 -n | head -n -${MAX_BUILDS} | xargs rm -rf 2>/dev/null || true
          cd ..

          # â”€â”€ Commit and push â”€â”€
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --cached --quiet \
            && echo "â„¹ï¸  No changes to commit" \
            || git commit -m "chore(regression): build #${BUILD} [skip ci]"
          git push origin gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1ï¸âƒ£2ï¸âƒ£  Upload artifacts
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload Regression Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-artifacts-build-${{ steps.build.outputs.number }}
          if-no-files-found: warn
          retention-days: 30
          path: |
            target/allure-results/
            allure-report-regression/
            target/defect-age-report.csv
            test-output/failedLocators_*.json

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1ï¸âƒ£3ï¸âƒ£  Report outcome â€” non-blocking
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Report Regression Outcome
        if: always()
        run: |
          if [ "${{ steps.run.outcome }}" = "failure" ]; then
            echo "âš ï¸  Regression tests FAILED â€” check the report"
            echo "â„¹ï¸  Pipeline continues â€” regression is non-blocking"
          else
            echo "âœ… All regression tests passed"
          fi