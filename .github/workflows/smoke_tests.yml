name: Smoke Tests Execution

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      env:
        description: 'Test environment'
        default: 'staging'
      browser:
        description: 'Browser to run tests'
        default: 'chrome'
      headless:
        description: 'Headless mode'
        default: 'true'
      threadcount:
        description: 'Parallel threads'
        default: '1'
      tag:
        description: 'Cucumber tags'
        default: '@smoke'

jobs:
  smoke-job:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1ï¸âƒ£  Checkout main branch (workspace root)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout Main
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2ï¸âƒ£  Setup Java 21
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3ï¸âƒ£  Install Allure CLI & Playwright browsers
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Allure CLI + Playwright
        run: |
          npm install -g allure-commandline
          npx playwright install --with-deps

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4ï¸âƒ£  Restore Allure history from gh-pages
      #      continue-on-error: true handles first-ever run
      #      where gh-pages branch does not yet exist
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout gh-pages for History
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Restore Smoke History into allure-results
        run: |
          rm -rf target/allure-results
          mkdir -p target/allure-results/history
          if [ -d gh-pages/allure-history/smoke/history ]; then
            echo "âœ… Prior smoke history found â€” restoring"
            cp -r gh-pages/allure-history/smoke/history/. target/allure-results/history/
          else
            echo "â„¹ï¸  No prior smoke history â€” this may be the first run"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5ï¸âƒ£  Run Smoke Tests
      #      || fallbacks ensure push-triggered runs
      #      never hit missing input errors
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Smoke Tests
        id: run
        continue-on-error: true
        run: |
          xvfb-run --auto-servernum -- mvn clean test \
            -Dcucumber.filter.tags="${{ github.event.inputs.tag || '@smoke' }}" \
            -Denv="${{ github.event.inputs.env || 'staging' }}" \
            -Dbrowser="${{ github.event.inputs.browser || 'chrome' }}" \
            -Dheadless="${{ github.event.inputs.headless || 'true' }}" \
            -Dthreadcount="${{ github.event.inputs.threadcount || '1' }}"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6ï¸âƒ£  Debug â€” verify all expected output paths
      #      Safe to remove after first successful run
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Debug â€” Verify Output Paths
        if: always()
        run: |
          echo "====== target/allure-results ======"
          ls -la target/allure-results/ || echo "âŒ NOT FOUND"
          echo "====== target/allure-results/history ======"
          ls -la target/allure-results/history/ || echo "âŒ history folder empty or missing"
          echo "====== target/allure-results/environment.properties ======"
          cat target/allure-results/environment.properties || echo "âŒ NOT FOUND â€” AllureEnvironmentManager may not have run yet"
          echo "====== test-output (failedLocators) ======"
          ls -la test-output/ || echo "âŒ test-output folder NOT FOUND"
          echo "====== defect-age-report.csv ======"
          find . -name "defect-age-report.csv" | head -5 || echo "âŒ NOT FOUND â€” AllureDefectAge may not have run yet"
          echo "====== failedLocators json files ======"
          find . -name "failedLocators_*.json" | head -5 || echo "âŒ NOT FOUND"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7ï¸âƒ£  Generate Defect Age + Environment file
      #      AllureDefectAge also calls AllureEnvironmentManager
      #      internally â€” no separate env step needed
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate Defect Age Report
        if: always()
        run: |
          mvn exec:java \
            -Dexec.mainClass="com.samtech.qa.testutilities.AllureDefectAge" \
            -Dexec.classpathScope=test
          echo "====== environment.properties after AllureDefectAge ======"
          cat target/allure-results/environment.properties || echo "âŒ environment.properties still missing"
          echo "====== defect-age-report.csv after AllureDefectAge ======"
          cat target/defect-age-report.csv || echo "âŒ defect-age-report.csv NOT generated"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8ï¸âƒ£  Generate Allure HTML report
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate Allure Report
        if: always()
        run: |
          allure generate target/allure-results -o allure-report-smoke --clean
          echo "====== allure-report-smoke/history ======"
          ls -la allure-report-smoke/history/ || echo "âŒ history not present in generated report"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 9ï¸âƒ£  Deploy Smoke Report to GitHub Pages
      #      keep_files: true so regression-report
      #      is not wiped when smoke deploys
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy Smoke Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report-smoke
          destination_dir: smoke-report
          keep_files: true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ğŸ”Ÿ  Persist updated Allure history to gh-pages
      #      Re-clones gh-pages after peaceiris deploy
      #      because peaceiris force-pushes and invalidates
      #      any prior local clone of that branch
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Save Smoke History to gh-pages
        if: always()
        run: |
          rm -rf gh-pages
          git clone --branch gh-pages --single-branch \
            https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git \
            gh-pages
          mkdir -p gh-pages/allure-history/smoke
          rm -rf gh-pages/allure-history/smoke/history
          cp -r allure-report-smoke/history gh-pages/allure-history/smoke/history
          cd gh-pages
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add allure-history/smoke/history
          git diff --cached --quiet \
            && echo "â„¹ï¸  No history changes to commit" \
            || git commit -m "chore(smoke): update allure history [skip ci]"
          git push origin gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1ï¸âƒ£1ï¸âƒ£  Upload ALL four artifacts
      #      - target/allure-results     (raw results)
      #      - allure-report-smoke       (HTML report)
      #      - target/defect-age-report.csv
      #      - test-output/failedLocators_*.json
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload Smoke Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-artifacts
          if-no-files-found: warn
          path: |
            target/allure-results/
            allure-report-smoke/
            target/defect-age-report.csv
            test-output/failedLocators_*.json

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1ï¸âƒ£2ï¸âƒ£  Fail build on ANY smoke test failure
      #         Industry standard: smoke = quality gate
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Fail Build on Smoke Failure
        if: always()
        run: |
          if [ "${{ steps.run.outcome }}" = "failure" ]; then
            echo "âŒ One or more smoke tests FAILED â€” blocking pipeline"
            exit 1
          else
            echo "âœ… All smoke tests passed"
          fi